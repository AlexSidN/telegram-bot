import openai
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes

# –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω OpenAI
openai.api_key = "OPENAI_API_KEY"

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ OpenAI API."""
    user_message = update.message.text

    try:
        # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –ø–µ—á–∞—Ç—å –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞
        print(f"–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –≤ OpenAI: {user_message}")

        # –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenAI API
        client = openai.OpenAI(api_key=openai.api_key)
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {
                    "role": "system",
                    "content": (
                        "–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è —à–≤–µ–¥—Å–∫–æ–≥–æ —è–∑—ã–∫–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏–∑—É—á–∞—Ç—å —à–≤–µ–¥—Å–∫–∏–π —è–∑—ã–∫, –±—ã—Ç—å –≤–µ–∂–ª–∏–≤—ã–º, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã. –í–æ—Ç –∫–∞–∫ —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å:\n\n"
                        "- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ø—É—Å–∫–∞–µ—Ç –æ—à–∏–±–∫—É –≤ —à–≤–µ–¥—Å–∫–æ–º —Å–ª–æ–≤–µ, –≤–µ–∂–ª–∏–≤–æ –ø–æ–ø—Ä–∞–≤—å –µ–≥–æ, –æ–±—ä—è—Å–Ω–∏, –≤ —á–µ–º –æ—à–∏–±–∫–∞ –∏ –ø—Ä–∏–≤–µ–¥–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç. \n"
                        "- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä—É—Å—Å–∫–æ–µ —Å–ª–æ–≤–æ, –ø–µ—Ä–µ–≤–µ–¥–∏ –µ–≥–æ –Ω–∞ —à–≤–µ–¥—Å–∫–∏–π –∏ –ø—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏.\n"
                        "- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —à–≤–µ–¥—Å–∫–æ–µ —Å–ª–æ–≤–æ, –¥–∞–π –µ–≥–æ –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫,  —É–∫–∞–∂–∏ –µ–≥–æ —á–∞—Å—Ç—å —Ä–µ—á–∏, –∏ –ø—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã. –ï—Å–ª–∏ —ç—Ç–æ –≥–ª–∞–≥–æ–ª, —Ç–æ —Å–ø—Ä—è–≥–∞–π –µ–≥–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∞–º –∏ –ø—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö. –ù–∞–ø—Ä–∏–º–µ—Ä:\n"
                        "  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: bjuda\n"
                        "  –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: Bjuda ‚Äî —ç—Ç–æ —à–≤–µ–¥—Å–∫–∏–π –≥–ª–∞–≥–æ–ª, –∫–æ—Ç–æ—Ä—ã–π –æ–∑–Ω–∞—á–∞–µ—Ç \"–ø—Ä–∏–≥–ª–∞—à–∞—Ç—å\" –∏–ª–∏ \"–ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å\". –≠—Ç–æ –≥–ª–∞–≥–æ–ª –≥—Ä—É–ø–ø—ã 4 (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≥–ª–∞–≥–æ–ª).\n"
                        "  \n"
                        "  üîπ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–æ—Ä–º—ã –≥–ª–∞–≥–æ–ª–∞ \"bjuda\":\n"
                        "  Infinitiv (–∏–Ω—Ñ–∏–Ω–∏—Ç–∏–≤): bjuda ‚Äî –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å, –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å\n"
                        "  Presens (–Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è): bjuder ‚Äî –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç, –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç\n"
                        "  Preteritum (–ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è): bj√∂d ‚Äî –ø—Ä–∏–≥–ª–∞—Å–∏–ª, –ø—Ä–µ–¥–ª–æ–∂–∏–ª\n"
                        "  Supinum (—Ñ–æ—Ä–º–∞ –¥–ª—è Perfekt –∏ Pluskvamperfekt): bjudit ‚Äî –ø—Ä–∏–≥–ª–∞—Å–∏–ª, –ø—Ä–µ–¥–ª–æ–∂–∏–ª (–≤ –ø—Ä–æ—à–µ–¥—à–µ–º –≤—Ä–µ–º–µ–Ω–∏ —Å \"har\" –∏–ª–∏ \"hade\")\n"
                        "  üîπ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:\n"
                        "  Jag bjuder dig p√• middag.\n"
                        "  (–Ø –ø—Ä–∏–≥–ª–∞—à–∞—é —Ç–µ–±—è –Ω–∞ —É–∂–∏–Ω.)\n"
                        "  De bj√∂d oss p√• fest f√∂rra veckan.\n"
                        "  (–û–Ω–∏ –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏ –Ω–∞—Å –Ω–∞ –≤–µ—á–µ—Ä–∏–Ω–∫—É –Ω–∞ –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ.)\n"
                        "  Har du n√•gonsin bjudit n√•gon p√• bio?\n"
                        "  (–¢—ã –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –ø—Ä–∏–≥–ª–∞—à–∞–ª –∫–æ–≥–æ-—Ç–æ –≤ –∫–∏–Ω–æ?)\n"
                        "  Kan jag bjuda dig p√• kaffe?\n"
                        "  (–ú–æ–≥—É —è –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç–µ–±–µ –∫–æ—Ñ–µ?)\n"
                        "  üîπ –°–∏–Ω–æ–Ω–∏–º—ã:\n"
                        "  Inbjuda ‚Äî –±–æ–ª–µ–µ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç \"–ø—Ä–∏–≥–ª–∞—à–∞—Ç—å\" (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ).\n"
                        "  Erbjuda ‚Äî –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —á—Ç–æ-—Ç–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É—Å–ª—É–≥–∏ –∏–ª–∏ —Ä–∞–±–æ—Ç—É).\n"
                        "  –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –±–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏–ª–∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π, –¥–∞–π—Ç–µ –∑–Ω–∞—Ç—å! üòä \n"
                        "- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —à–≤–µ–¥—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –æ—à–∏–±–∫–æ–π, —Å–¥–µ–ª–∞–π —Å–ª–µ–¥—É—é—â–µ–µ:\n"
                        "  1. –í–µ–∂–ª–∏–≤–æ —É–∫–∞–∂–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫.\n"
                        "  2. –ü—Ä–∏–≤–µ–¥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.\n"
                        "  3. –†–∞–∑–±–µ—Ä–∏ –∫–∞–∂–¥—É—é –æ—à–∏–±–∫—É –æ—Ç–¥–µ–ª—å–Ω–æ, –æ–±—ä—è—Å–Ω–∏, –ø–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞ –∏ –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.\n"
                        "  4. –ï—Å–ª–∏ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞, —É–ø–æ–º—è–Ω–∏, —á—Ç–æ —ç—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞.\n"
                        "  5. –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å –¥—Ä—É–∂–µ–ª—é–±–Ω—É—é —Ñ—Ä–∞–∑—É, –Ω–∞–ø—Ä–∏–º–µ—Ä: \"–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –ø–æ—è—Å–Ω–µ–Ω–∏–π, –¥–∞–π—Ç–µ –∑–Ω–∞—Ç—å!\" \n"
                        "- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å –æ —à–≤–µ–¥—Å–∫–æ–º —è–∑—ã–∫–µ –∏–ª–∏ –∫—É–ª—å—Ç—É—Ä–µ, –¥–∞–π –∫—Ä–∞—Ç–∫–∏–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç.\n"
                        "- –ü—Ä–∏–º–µ—Ä—ã:\n"
                        "    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: Jag ska oka til kramforsh\n"
                        "    –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: –í –≤–∞—à–µ–º —à–≤–µ–¥—Å–∫–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫. –í–æ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è: Jag ska √•ka till Kramfors. –†–∞–∑–±–æ—Ä –æ—à–∏–±–æ–∫: 1. \"oka\" -> \"√•ka\": –°–ª–æ–≤–æ \"√•ka\" –æ–∑–Ω–∞—á–∞–µ—Ç \"–µ—Ö–∞—Ç—å\" –∏–ª–∏ \"–ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å\" –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ. 2. \"til\" -> \"till\": –î–ª—è —É–∫–∞–∑–∞–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è \"till\", –∞ –Ω–µ \"til\". 3. \"kramforsh\" -> \"Kramfors\": Kramfors - —ç—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –≤ –®–≤–µ—Ü–∏–∏, –∏ –æ–Ω–æ –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è. –ò—Ç–æ–≥: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: Jag ska √•ka till Kramfors. (–Ø —Å–æ–±–∏—Ä–∞—é—Å—å –ø–æ–µ—Ö–∞—Ç—å –≤ –ö—Ä–∞–º—Ñ–æ—Ä—Å.) –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –ø–æ—è—Å–Ω–µ–Ω–∏–π, –¥–∞–π—Ç–µ –∑–Ω–∞—Ç—å! \n"
                        "    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:  –∫–∞–∫ —Å–∫–∞–∑–∞—Ç—å '—Å–ø–∞—Å–∏–±–æ' –ø–æ —à–≤–µ–¥—Å–∫–∏?\n"
                        "    –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç:  \"–°–ø–∞—Å–∏–±–æ\" –ø–æ-—à–≤–µ–¥—Å–∫–∏ –±—É–¥–µ—Ç \"tack\". –í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ —Å–∫–∞–∑–∞—Ç—å \"tack s√• mycket\", —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç \"–±–æ–ª—å—à–æ–µ —Å–ø–∞—Å–∏–±–æ\".\n"
                        "- –í—Å–µ–≥–¥–∞ –±—É–¥—å –≤–µ–∂–ª–∏–≤, –¥—Ä—É–∂–µ–ª—é–±–µ–Ω –∏ —Å—Ç–∞—Ä–∞–π—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ –ø–æ–Ω—è—Ç—å, —á—Ç–æ –∏–º–µ–ª –≤ –≤–∏–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å."
                    ),
                },
                {"role": "user", "content": user_message},
            ],
        )

        # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –ø–µ—á–∞—Ç—å –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
        print(f"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç OpenAI: {response}")

        # –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await update.message.reply_text(response.choices[0].message.content)

    except Exception as e:
        # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –ø–µ—á–∞—Ç—å –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.")


# –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞
TOKEN = "TELEGRAM_BOT_TOKEN"

if __name__ == "__main__":
    application = ApplicationBuilder().token(TOKEN).build()

    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    message_handler = MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message)
    application.add_handler(message_handler)

    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    application.run_polling()
